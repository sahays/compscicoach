{{#> main}}
    <div class="grid grid-cols-12 w-full gap-2">
        <section class="col-auto md:col-span-3">

        </section>
        <section class="col-span-12 md:col-span-6">
            <form id="userForm">
                <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-white">Add a new Author</h2>

                <div class="mb-4">
                    <label for="name" class="block text-gray-700 dark:text-white text-sm font-bold mb-2">Name:</label>
                    <div class="flex-row md:flex gap-4">
                        <input type="text" id="first_name" name="first_name"
                            class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight"
                            placeholder="given name" required>
                        <input type="text" id="last_name" name="last_name"
                            class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight"
                            placeholder="family name" required>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="email" class="block text-gray-700 dark:text-white text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="email" name="email"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight"
                        placeholder="Email" required>
                </div>

                <div class="mb-4">
                    <label for="bio" class="block text-gray-700  dark:text-white text-sm font-bold mb-2">Bio:</label>
                    <textarea id="bio" name="bio" rows="5"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight"
                        placeholder="Tell us about yourself (use markdown)" required></textarea>
                </div>

                <div class="mb-4">
                    <label for="photo-field" class="block text-gray-700 dark:text-white text-sm font-bold mb-2">Upload a
                        Profile Photo</label>
                    <div class="flex-row md:flex items-baseline">
                        <input type="file" id="photo-field" name="photo" class="mb-4"
                            accept=".jpg,.jpeg,.png,.gif, .svg" />
                        <div class="flex md:justify-end w-full">
                            <button type="button" id="upload-button" disabled>Upload
                                photo</button>
                        </div>

                    </div>
                    <div id="photo-field-error">
                    </div>
                    <div class="mt-2">
                        <img src="/assets/images/headshot.png" id="profile-photo" alt="Profile Photo"
                            class="object-cover border rounded-full w-[48px] h-[48px] bg-white">
                    </div>

                </div>

                <div class="mb-4">
                    <label for="intro"
                        class="block text-gray-700  dark:text-white text-sm font-bold mb-2">Intro:</label>
                    <textarea id="intro" name="intro"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight"
                        rows="5" placeholder="A short introduction (use markdown)" required></textarea>
                </div>

                <input type="hidden" id="schema" value="{{schema}}">

                <div class="flex justify-end">
                    <button type="submit" id="submit-button" class="button-flashy">
                        Submit
                    </button>
                </div>
            </form>
            <div id="errors" class="bg-yellow-100 text-black p-2 hidden">

            </div>
        </section>
        <section class="col-auto md:col-span-3">

        </section>
        <script type="module">
            import Ajv from 'https://cdn.skypack.dev/ajv';

            $(function () {
                $('#photo-field').on('change', function () {
                    var file = this.files[0];
                    console.info('File selected:', file.name);
                    var maxSize = 2 * 1024 * 1024; // 2 MB
                    var errorField = $('#photo-field-error');
                    var uploadButton = $('#upload-button');
                    if (file) {
                        if (file.name.length > 64) {
                            console.warn('File name exceeds 64 characters.');
                            errorField.text('File name exceeds 64 characters.');
                            $(this).val(''); // Clear the input
                            uploadButton.prop('disabled', true);
                        } else if (file.size > maxSize) {
                            console.warn('File size exceeds 2 MB.');
                            errorField.text('File size exceeds 2 MB.');
                            $(this).val(''); // Clear the input
                            uploadButton.prop('disabled', true);
                        } else {
                            console.info('File is valid.');
                            errorField.text('');
                            uploadButton.prop('disabled', false);
                        }
                    }
                });
                $('#upload-button').on('click', function () {
                    var file = $('#photo-field')[0].files[0];
                    var formData = new FormData();
                    formData.append('photo', file);
                    $.ajax({
                        url: '/api/photos',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (data) {
                            console.log('Upload successful:', data);
                            if (data.path) {
                                $('#profile-photo').attr('src', data.path);
                            }
                        },
                        error: function (err) {
                            console.error('Upload failed:', err);
                        }
                    });
                });
                $('#submit-button').on('click', function () {
                    var payload = {
                        first_name: $('#first_name').val(),
                        last_name: $('#last_name').val(),
                        email: $('#email').val(),
                        bio: $('#bio').val(),
                        intro: $('#intro').val(),
                        photo_url: $('#profile-photo').attr('src')
                    }
                    console.log('Creating author:', payload);

                    var schema = JSON.parse($('#schema').val());
                    const ajv = new Ajv({ allErrors: true });
                    const validate = ajv.compile(schema);
                    const valid = validate(payload);
                    $('#errors').empty();
                    if (!valid) {
                        validate.errors.forEach(error => {
                            const errorMessage = document.createElement('p');
                            errorMessage.classList.add('text-sm', 'p-1');
                            errorMessage.textContent = `${error.instancePath} ${error.message}`;
                            $('#errors').append(errorMessage).show();
                        });
                    } else {
                        $.ajax({
                            url: '/admin/author',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(payload),
                            success: function (data) {
                                console.log('Author created:', data);
                            },
                            error: function (err) {
                                console.error('Author creation failed:', err);
                            }
                        });
                    }
                });
            });
        </script>
    </div>
{{/main}}